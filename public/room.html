<!DOCTYPE html>
<html lang="ar">
<head>
  <meta charset="UTF-8">
  <title>ØºØ±ÙØ© Ù…Ø¯Ø§Ù‚Ø´</title>
  <link rel="stylesheet" href="style.css">
  <link href="https://fonts.googleapis.com/css2?family=Amiri&display=swap" rel="stylesheet">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
</head>
<body>
  <div class="container">
    <h1 class="title-small">Ù…Ø¯Ø§Ù‚Ø´</h1>
    <h2 id="room-info"></h2>

    <div id="admin-controls" style="margin: 10px 0;"></div>
    <div id="player-card" class="card my-card"></div>
    <div id="others"></div>
  </div>

  <script src="/socket.io/socket.io.js"></script>
  <script>
    const socket = io();
    const name = sessionStorage.getItem("name");
    const roomCode = sessionStorage.getItem("roomCode");

    const roomInfo = document.getElementById("room-info");
    const myCard = document.getElementById("player-card");
    const others = document.getElementById("others");
    const adminControls = document.getElementById("admin-controls");

    let canSend = true;

    roomInfo.innerText = `Ø±Ù…Ø² Ø§Ù„ØºØ±ÙØ©: ${roomCode} â€” Ø£Ù†Øª: ${name}`;

    if (!sessionStorage.getItem("joined")) {
      socket.emit("joinRoom", { username: name, roomCode }, (res) => {
        if (res?.error === "Room not found") {
          alert("âŒ Ø§Ù„ÙƒÙˆØ¯ ØºÙŠØ± ØµØ­ÙŠØ­ Ø£Ùˆ Ø§Ù„ØºØ±ÙØ© ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯Ø©.");
          location.href = "index.html";
        } else if (res?.error === "Duplicate name") {
          alert("âŒ Ù‡Ø°Ø§ Ø§Ù„Ø§Ø³Ù… Ù…Ø³ØªØ®Ø¯Ù… Ø¨Ø§Ù„ÙØ¹Ù„ Ø¯Ø§Ø®Ù„ Ø§Ù„ØºØ±ÙØ©.");
          location.href = "index.html";
        } else {
          sessionStorage.setItem("joined", "true");
        }
      });
    }

    socket.on("updatePlayers", (data) => {
      const players = data.players;
      const ownerId = data.ownerId;
      const isOwner = socket.id === ownerId;

      myCard.innerHTML = "";
      others.innerHTML = "";
      adminControls.innerHTML = "";

      roomInfo.innerText = `Ø±Ù…Ø² Ø§Ù„ØºØ±ÙØ©: ${roomCode} â€” Ø£Ù†Øª: ${name} ${isOwner ? "(Ù…Ø´Ø±Ù)" : ""}`;

      if (isOwner && !document.getElementById("deleteRoomBtn")) {
        const deleteBtn = document.createElement("button");
        deleteBtn.id = "deleteRoomBtn";
        deleteBtn.textContent = "ğŸš© Ø­Ø°Ù Ø§Ù„ØºØ±ÙØ©";
        deleteBtn.style.backgroundColor = "#dc2626";
        deleteBtn.onclick = () => {
          const sure = confirm("Ù‡Ù„ ØªØ±ÙŠØ¯ Ø­Ø°Ù Ø§Ù„ØºØ±ÙØ© Ù†Ù‡Ø§Ø¦ÙŠÙ‹Ø§ØŸ");
          if (sure) {
            socket.emit("deleteRoom", roomCode);
            alert("âœ… ØªÙ… Ø­Ø°Ù Ø§Ù„ØºØ±ÙØ©.");
            location.href = "index.html";
          }
        };
        adminControls.appendChild(deleteBtn);

        const qrDiv = document.createElement("div");
        qrDiv.style.position = "fixed";
        qrDiv.style.bottom = "10px";
        qrDiv.style.left = "10px";
        qrDiv.innerHTML = `
          <img src="img/frame.png" alt="QR Code" style="width: 110px;">
        `;
        document.body.appendChild(qrDiv);
      }

      players.forEach(player => {
        const div = document.createElement("div");
        div.className = "card";
        div.innerHTML = `<strong>${player.name}</strong><br>ğŸ’° ${player.balance.toLocaleString()} Ø±ÙŠØ§Ù„`;

        // âœ… Ø¥Ø°Ø§ Ù‡Ø°Ø§ Ø§Ù„Ù„Ø§Ø¹Ø¨ Ù‡Ùˆ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø§Ù„Ø­Ø§Ù„ÙŠ (Ø¨Ø§Ù„Ù€ socket.id)
        if (player.id === socket.id) {
          const input = document.createElement("input");
          input.type = "number";
          input.placeholder = "Ø§Ù„Ù…Ø¨Ù„Øº";

          const win = document.createElement("input");
          win.type = "radio";
          win.name = "action";
          win.value = "win";
          const winLabel = document.createElement("label");
          winLabel.textContent = " ÙƒØ³Ø¨ ";
          winLabel.prepend(win);

          const lose = document.createElement("input");
          lose.type = "radio";
          lose.name = "action";
          lose.value = "lose";
          const loseLabel = document.createElement("label");
          loseLabel.textContent = " Ø®Ø³Ø§Ø±Ø© ";
          loseLabel.prepend(lose);

          const btn = document.createElement("button");
          btn.textContent = "ØªØ£ÙƒÙŠØ¯";
          btn.disabled = !canSend;

          btn.onclick = () => {
            const amount = Number(input.value);
            const action = document.querySelector("input[name='action']:checked");

            if (!amount || !action) {
              alert("âš ï¸ Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø¥Ø¯Ø®Ø§Ù„ Ø§Ù„Ù…Ø¨Ù„Øº ÙˆØªØ­Ø¯ÙŠØ¯ ÙƒØ³Ø¨ Ø£Ùˆ Ø®Ø³Ø§Ø±Ø©.");
              return;
            }

            const finalAmount = action.value === "lose" ? -amount : amount;
            socket.emit("updateBalance", { roomCode, amount: finalAmount });

            input.value = "";
            win.checked = false;
            lose.checked = false;
            btn.disabled = true;
            canSend = false;
            setTimeout(() => {
              btn.disabled = false;
              canSend = true;
            }, 10000);
          };

          div.appendChild(document.createElement("br"));
          div.appendChild(input);
          div.appendChild(document.createElement("br"));
          div.appendChild(winLabel);
          div.appendChild(loseLabel);
          div.appendChild(document.createElement("br"));
          div.appendChild(btn);
          myCard.appendChild(div);
        } else {
          if (isOwner) {
            const input = document.createElement("input");
            input.type = "number";
            input.placeholder = "ØªØ¹Ø¯ÙŠÙ„ ÙŠØ¯ÙˆÙŠ";

            const btn = document.createElement("button");
            btn.textContent = "âœï¸ ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ø±ØµÙŠØ¯";
            btn.onclick = () => {
              const newBalance = Number(input.value);
              if (isNaN(newBalance)) return;
              socket.emit("manualUpdate", {
                roomCode,
                playerId: player.id,
                newBalance,
              });
              input.value = "";
            };

            div.appendChild(document.createElement("br"));
            div.appendChild(input);
            div.appendChild(btn);
          }

          others.appendChild(div);
        }
      });
    });
  </script>
</body>
</html>

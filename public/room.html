<!DOCTYPE html>
<html lang="ar">
<head>
  <meta charset="UTF-8">
  <title>ØºØ±ÙØ© Ù…Ø¯Ø§Ù‚Ø´</title>
  <link rel="stylesheet" href="style.css">
  <link href="https://fonts.googleapis.com/css2?family=Amiri&display=swap" rel="stylesheet">
</head>
<body>
  <div class="container">
    <!-- Ø§Ù„Ø¹Ù†ÙˆØ§Ù† -->
    <h1 class="title-small">Ù…Ø¯Ø§Ù‚Ø´</h1>
    <h2 id="room-info"></h2>

    <!-- Ø¨Ø·Ø§Ù‚Ø© Ø§Ù„Ù„Ø§Ø¹Ø¨ Ù†ÙØ³Ù‡ -->
    <div id="player-card" class="card my-card"></div>

    <!-- Ø¨Ø§Ù‚ÙŠ Ø§Ù„Ù„Ø§Ø¹Ø¨ÙŠÙ† -->
    <div id="others"></div>
  </div>

  <script src="/socket.io/socket.io.js"></script>
  <script>
    const socket = io();
    const name = sessionStorage.getItem("name");
    const roomCode = sessionStorage.getItem("roomCode");
    const isOwner = sessionStorage.getItem("isOwner") === "true";

    const roomInfo = document.getElementById("room-info");
    const myCard = document.getElementById("player-card");
    const others = document.getElementById("others");

    let canSend = true;

    // Ø¹Ø±Ø¶ Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… ÙˆØ±Ù…Ø² Ø§Ù„ØºØ±ÙØ©
    roomInfo.innerText = `Ø±Ù…Ø² Ø§Ù„ØºØ±ÙØ©: ${roomCode} â€” Ø£Ù†Øª: ${name} ${isOwner ? "(Ù…Ø´Ø±Ù)" : ""}`;

    socket.emit("joinRoom", { username: name, roomCode }, (res) => {
      if (res?.error) {
        alert("Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ù„Ù„ØºØ±ÙØ©.");
        location.href = "index.html";
      }
    });

    socket.on("updatePlayers", (players) => {
      myCard.innerHTML = "";
      others.innerHTML = "";

      players.forEach(player => {
        const div = document.createElement("div");
        div.className = "card";
        div.innerHTML = `<strong>${player.name}</strong><br>ğŸ’° ${player.balance.toLocaleString()} Ø±ÙŠØ§Ù„`;

        if (player.name === name) {
          // Ø¨Ø·Ø§Ù‚Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ù†ÙØ³Ù‡
          const input = document.createElement("input");
          input.type = "number";
          input.placeholder = "Ø§Ù„Ù…Ø¨Ù„Øº";

          const win = document.createElement("input");
          win.type = "radio";
          win.name = "action";
          win.value = "win";
          const winLabel = document.createElement("label");
          winLabel.textContent = " ÙƒØ³Ø¨ ";
          winLabel.prepend(win);

          const lose = document.createElement("input");
          lose.type = "radio";
          lose.name = "action";
          lose.value = "lose";
          const loseLabel = document.createElement("label");
          loseLabel.textContent = " Ø®Ø³Ø§Ø±Ø© ";
          loseLabel.prepend(lose);

          const btn = document.createElement("button");
          btn.textContent = "ØªØ£ÙƒÙŠØ¯";
          btn.disabled = !canSend;

          btn.onclick = () => {
            const amount = Number(input.value);
            const action = document.querySelector("input[name='action']:checked");
            if (!amount || !action) return alert("âš ï¸ Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø¥Ø¯Ø®Ø§Ù„ Ø§Ù„Ù…Ø¨Ù„Øº ÙˆØªØ­Ø¯ÙŠØ¯ Ù†ÙˆØ¹ Ø§Ù„Ø¹Ù…Ù„ÙŠØ©.");
            const finalAmount = action.value === "lose" ? -amount : amount;

            socket.emit("updateBalance", { roomCode, amount: finalAmount });
            input.value = "";
            win.checked = false;
            lose.checked = false;
            btn.disabled = true;
            canSend = false;
            setTimeout(() => {
              btn.disabled = false;
              canSend = true;
            }, 10000);
          };

          div.appendChild(document.createElement("br"));
          div.appendChild(input);
          div.appendChild(document.createElement("br"));
          div.appendChild(winLabel);
          div.appendChild(loseLabel);
          div.appendChild(document.createElement("br"));
          div.appendChild(btn);
          myCard.appendChild(div);
        } else {
          if (isOwner) {
            const input = document.createElement("input");
            input.type = "number";
            input.placeholder = "ØªØ¹Ø¯ÙŠÙ„ ÙŠØ¯ÙˆÙŠ";

            const btn = document.createElement("button");
            btn.textContent = "âœï¸ ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ø±ØµÙŠØ¯";
            btn.onclick = () => {
              const newBalance = Number(input.value);
              if (isNaN(newBalance)) return;
              socket.emit("manualUpdate", {
                roomCode,
                playerId: player.id,
                newBalance,
              });
              input.value = "";
            };

            div.appendChild(document.createElement("br"));
            div.appendChild(input);
            div.appendChild(btn);
          }
          others.appendChild(div);
        }
      });
    });
  </script>
</body>
</html>
